{% extends "base.html" %}

{% block title %}ì—”ì§„ ì†Œë¦¬ ë…¹ìŒ - ìë™ì°¨ ì†ŒìŒ ì´ìƒ íƒì§€{% endblock %}
{% block body_class %}page-md{% endblock %}

{% block content %}

<style>
/* ê¸°ë³¸ì€ ì •ì§€ */
.animated-logo {
    animation-play-state: paused;
}

/* ì‹œí¬ë¦¿ í‚¤ í†µê³¼ í›„ì—ë§Œ ì‹¤í–‰ */
body.secret-unlocked .animated-logo {
    animation-play-state: running;
}

/* ì „ì²´ í™”ë©´ì„ ë®ëŠ” ê²€ì€ ê°€ë¦¼ë§‰ */
.secret-overlay {
    position: fixed;
    inset: 0;                       /* top/right/bottom/left: 0; */
    background: rgba(2, 4, 12, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;                  /* ë§¨ ì•ì— */
}

/* ê°€ìš´ë° ì„œë¸Œ ì°½ */
.secret-modal {
    position: relative;
    max-width: 540px;
    width: 90%;
    padding: 24px 24px 20px;
    border-radius: 24px;
    background: transparent;        /* ì•ˆìª½ë„ ê³µë°± ëŠë‚Œ */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
}

/* ë¡œê³  ì´ë¯¸ì§€ */
.secret-img {
    max-width: 1400px;
    width: 100%;
    height: auto;
    display: block;
}

/* ì…ë ¥ ë°•ìŠ¤ ì˜ì—­ */
.secret-input-wrap {
    width: 100%;
    text-align: center;
    color: #f5f7ff;
    font-size: 14px;
}

.secret-title {
    margin-bottom: 8px;
    color: #dce5ff;
}

.secret-input {
    width: 100%;
    max-width: 260px;
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: rgba(10, 14, 40, 0.9);
    color: #f5f7ff;
    outline: none;
    font-size: 14px;
}

.secret-input:focus {
    border-color: #00e5ff;
    box-shadow: 0 0 10px rgba(0, 229, 255, 0.6);
}

.secret-btn {
    margin-top: 10px;
    padding: 8px 26px;
    border-radius: 999px;
    border: none;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    background: linear-gradient(90deg, #00e5ff, #7f5dff);
    color: #020615;
    box-shadow: 0 0 16px rgba(0, 229, 255, 0.6);
}

.secret-btn:hover {
    transform: translateY(-1px);
}

.secret-error {
    margin-top: 8px;
    font-size: 12px;
    color: #ff6b6b;
}

:root {
    --md-content-width: 1000px;
}

/* ===================== 1. í° ë…¹ìŒ ì¹´ë“œ + íŒŒí˜• ì´í™íŠ¸ ===================== */

/* í° ì¹´ë“œ ìì²´ë¥¼ ë²„íŠ¼ìœ¼ë¡œ ì‚¬ìš© */
.em-rec-btn {
    width: 640px;           /* ì •ì‚¬ê°í˜• */
    height: 640px;
    max-width: 100%;
    margin: 32px auto 20px;
    padding: 0;

    /* ğŸ”¹ ë™ê·¸ë€ ë²„íŠ¼ìœ¼ë¡œ */
    border-radius: 50%;
    border: none;

    /* ğŸ”¹ ì¹´ë“œ ë°°ê²½/í…Œë‘ë¦¬/ê·¸ë¦¼ì ëª¨ë‘ ì œê±° (ê³µë°±ì²˜ëŸ¼) */
    background: transparent;
    box-shadow: none;

    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;

    overflow: hidden;       /* íŒŒí˜•ì´ ì› ë°–ìœ¼ë¡œ ëª» ë‚˜ê°€ê²Œ */

    color: #f5f7ff;
    outline: none;

    transition:
        transform 0.22s ease,
        opacity 0.2s ease;
}

.em-rec-btn:hover:not(:disabled) {
    transform: scale(1.03);   /* ì‚´ì§ ì»¤ì§€ëŠ” íš¨ê³¼ë§Œ ë‚¨ê¹€ */
}

.em-rec-btn:disabled {
    cursor: default;
    opacity: 0.6;
    transform: none;
}

.wave-container {
    position: absolute;
    left: 50%;
    top: 50%;
    /* ğŸ”¹ ë²„íŠ¼ ì¤‘ì‹¬ ê¸°ì¤€ìœ¼ë¡œ ì •ì¤‘ì•™ ë°°ì¹˜ */
    transform: translate(-50%, -50%);

    /* ğŸ”¹ ì› ì•ˆìª½ë§Œ ì“°ë„ë¡ ì‚´ì§ ì‘ê²Œ */
    width: 90%;
    height: 90%;

    pointer-events: none;
}

.wave-layer {
    position: absolute;
    left: 50%;
    top: 50%;
    width: 100%;
    height: 100%;
    transform: translate(-50%, -50%) scale(0.4) rotate(0deg);
    opacity: 0;
    animation: wavePulse 7s linear infinite;
    filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.6));
}

/* ë ˆì´ì–´ë³„ ì‹œì‘ ì‹œê°„ë§Œ ì¡°ê¸ˆì”© ë‹¤ë¥´ê²Œ (10ì¥) */
.wave-1  { animation-delay: 0s;   }
.wave-2  { animation-delay: 0.5s; }
.wave-3  { animation-delay: 1.0s; }
.wave-4  { animation-delay: 1.5s; }
.wave-5  { animation-delay: 2.0s; }
.wave-6  { animation-delay: 2.5s; }
.wave-7  { animation-delay: 3.0s; }
.wave-8  { animation-delay: 3.5s; }
.wave-9  { animation-delay: 4.0s; }
.wave-10 { animation-delay: 4.5s; }

/* íŒŒí˜•ì´ ë°•ìŠ¤ ì•ˆì—ì„œ í¼ì§€ë©´ì„œ + íšŒì „í•˜ë©´ì„œ ì‚¬ë¼ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
@keyframes wavePulse {
    0% {
        transform: translate(-50%, -50%) scale(0.4) rotate(0deg);
        opacity: 0;
    }
    10% {
        opacity: 0.9;
    }
    40% {
        transform: translate(-50%, -50%) scale(0.75) rotate(120deg);
        opacity: 0.7;
    }
    70% {
        transform: translate(-50%, -50%) scale(0.95) rotate(240deg);
        opacity: 0.25;
    }
    100% {
        transform: translate(-50%, -50%) scale(1.0) rotate(360deg);
        opacity: 0;
    }
}

/* ì¹´ë“œ ì•ˆì— ë‚˜íƒ€ë‚˜ëŠ” "ë…¹ìŒ ì¤‘ë‹¨" í…ìŠ¤íŠ¸ (ë…¹ìŒ ì¤‘ì—ë§Œ) */
.em-rec-label {
    position: absolute;
    bottom: 26px;
    left: 50%;
    transform: translateX(-50%);
    padding: 7px 20px;
    border-radius: 999px;
    border: 1px solid rgba(0, 255, 255, 0.75);
    background: rgba(2, 10, 25, 0.9);
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.05em;
    color: #a00000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

/* ë…¹ìŒ ì¤‘ì¼ ë•Œë§Œ ë³´ì´ê²Œ */
.em-rec-btn.recording .em-rec-label {
    opacity: 1;
}

/* ì¹´ë“œ ì•„ë˜ ìƒíƒœ í…ìŠ¤íŠ¸ */
.record-status {
    text-align: center;
    font-size: 13px;
    color: #cdd5ff;
    margin-bottom: 10px;
}

/* ë¡œê·¸(ì„ íƒ) */
.em-log {
    max-width: 720px;
    margin: 0 auto 24px;
    font-size: 12px;
    color: #9aa4ff;
    white-space: pre-line;
}

/* ë°˜ì‘í˜• */
@media (max-width: 900px) {
    .em-rec-btn {
        max-width: 100%;
        margin: 24px 12px 16px;
        height: 360px;
        border-radius: 24px;
    }

    .wave-container {
        inset: 0;
    }
}

/* ===================== 2. ì§„ë‹¨ ê²°ê³¼ ë°•ìŠ¤ ===================== */

.md-result-box {
    width: 100%;
    max-width: var(--md-content-width);
    margin: 24px auto 40px;
    border-radius: 18px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.55),
        0 0 24px rgba(255, 255, 255, 0.918);
    padding: 18px 22px;
    color: #f5f7ff;

    display: grid;
    grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
    gap: 18px;
    align-items: stretch;
}

.md-result-left {
    display: flex;
    flex-direction: column;
}

.md-result-title {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 10px;
}

.md-result-text {
    font-size: 18px;
    line-height: 1.7;
    white-space: pre-line;
}

.md-result-f1-wrap {
    display: flex;
    flex-direction: column;
    gap: 6px;
    height: 100%;
}

.md-result-f1-title {
    font-size: 13px;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.72);
    text-align: center;
}

.md-result-f1-box {
    flex: 1;
    background: rgba(5, 10, 30, 0.9);
    border-radius: 12px;
    padding: 8px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.5);
    display: flex;
}

.md-result-f1-img {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: contain;
}

@media (max-width: 768px) {
    .md-result-box {
        grid-template-columns: minmax(0, 1fr);
    }
}

/* ===================== 3. MD ì‹œê°í™” íŒ¨ë„ ===================== */

.md-viz-img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
}

.md-viz-panel {
    display: block;
    width: 100%;
    max-width: var(--md-content-width);
    margin: 24px auto 0;
    border-radius: 18px;
    background: var(--glass-bg);
    backdrop-filter: blur(22px);
    -webkit-backdrop-filter: blur(22px);
    border: 1px solid var(--glass-border);
    box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.55),
        0 0 24px rgba(255, 255, 255, 0);
    overflow: hidden;
    color: #f5f7ff;
    transition: max-height 0.35s ease, opacity 0.25s ease;
}

.md-viz-panel.collapsed {
    max-height: 48px;
    opacity: 0.85;
    overflow: hidden;
}

.md-viz-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-height: 10px;
    padding: 18px 22px;
    cursor: pointer;
}

.md-viz-pin {
    border: none;
    background: transparent;
    font-size: 20px;
    cursor: pointer;
    padding: 0;
    transform-origin: center;
    transition: transform 0.25s ease, filter 0.25s ease;
    filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0));
    margin-right: 8px;
}

.md-viz-panel.collapsed .md-viz-pin {
    transform: rotate(-30deg);
    filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.8));
}

.md-viz-center {
    flex: 1;
    text-align: center;
}

.md-viz-right {
    white-space: nowrap;
}

.md-viz-title {
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.9);
}

.md-viz-sub {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.65);
}

.md-viz-body {
    padding: 10px 18px 18px;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
}

.md-viz-row {
    display: block;
    margin-bottom: 14px;
}

.md-viz-block-full {
    width: 100%;
}

.md-viz-block-title {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 4px;
    color: rgba(255, 255, 255, 0.82);
}

.md-viz-canvas-box {
    background: rgba(5, 10, 30, 0.9);
    border-radius: 12px;
    padding: 8px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.5);
    min-height: 240px;
}
</style>
<!-- ğŸ”’ ë¹„ë°€í‚¤ ì…ë ¥ ì˜¤ë²„ë ˆì´ -->
<div id="secret-overlay" class="secret-overlay">
  <div class="secret-modal">
    <img src="{{ url_for('static', filename='images/car_logo3.png') }}"
         alt="secret gate"
         class="secret-img">

    <div class="secret-input-wrap">
      <p class="secret-title">ì ‘ì†ì„ ìœ„í•œ ë¹„ë°€ í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
      <input type="password"
             id="secret-input"
             class="secret-input"
             placeholder="Secret key" />

      <button type="button"
              id="secret-submit"
              class="secret-btn">
        í™•ì¸
      </button>

      <p id="secret-error" class="secret-error" style="display:none;">
        ë¹„ë°€ í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.
      </p>
    </div>
  </div>
</div>
<div class="content-section active" id="em-record">
    <div class="section-header-small">
        <div class="small-logo2">
            <img src="{{ url_for('static', filename='images/car_logo3.png') }}"
                 alt="Engine Logo"
                 class="header-engine-logo animated-logo">
        </div>
        <div class="small-brand">
            <h3>Car_AnomCar_aly Detection</h3>
            <p>ê³„ì¸¡ ëª¨ë“œ</p>
        </div>
    </div>

    <a class="back-btn" href="{{ url_for('main.index') }}">â† Back to Menu</a>

    <div class="section-header">
        <h2 class="section-title">Measurement Mode</h2>
        <p class="section-subtitle">
            ìŒíŒŒ ì»¨í…Œì´ë„ˆë¥¼ ëˆ„ë¥´ë©´ ì‹¤ì‹œê°„ ì§„ë‹¨ì„ ì‹œì‘í•©ë‹ˆë‹¤.
        </p>
    </div>

    <!-- ğŸ”¹ ì»¤ë‹¤ë€ ì¹´ë“œ = ë²„íŠ¼ (ê¸°ëŠ¥ ê·¸ëŒ€ë¡œ ìœ ì§€) -->
    <button type="button" class="em-rec-btn" id="em-rec-btn">
        <div class="wave-container">
            <!-- íŒŒí˜•ìš© ì´ë¯¸ì§€ 10ì¥ -->
            <img src="{{ url_for('static', filename='images/car_logo5.png') }}" class="wave-layer wave-1"  alt="">
            <img src="{{ url_for('static', filename='images/car_logo5.png') }}" class="wave-layer wave-2"  alt="">
            <img src="{{ url_for('static', filename='images/car_logo5.png') }}" class="wave-layer wave-3"  alt="">
            <img src="{{ url_for('static', filename='images/car_logo5.png') }}" class="wave-layer wave-4"  alt="">
            <img src="{{ url_for('static', filename='images/car_logo5.png') }}" class="wave-layer wave-5"  alt="">
            <img src="{{ url_for('static', filename='images/car_logo5.png') }}" class="wave-layer wave-6"  alt="">
            <img src="{{ url_for('static', filename='images/car_logo5.png') }}" class="wave-layer wave-7"  alt="">
            <img src="{{ url_for('static', filename='images/car_logo5.png') }}" class="wave-layer wave-8"  alt="">
            <img src="{{ url_for('static', filename='images/car_logo5.png') }}" class="wave-layer wave-9"  alt="">
            <img src="{{ url_for('static', filename='images/car_logo5.png') }}" class="wave-layer wave-10" alt="">
        </div>

        <!-- ë…¹ìŒ ì¤‘ì¼ ë•Œë§Œ ë³´ì´ëŠ” ë¼ë²¨ -->
        <div class="em-rec-label" id="em-rec-label">ë…¹ìŒ ì¤‘ë‹¨</div>
    </button>

    <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
    <div id="em-status" class="record-status">
        ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ë…¹ìŒì„ ì‹œì‘í•©ë‹ˆë‹¤.
    </div>

    <div id="em-log" class="em-log"></div>

    <!-- ====== VISUALIZATION íŒ¨ë„ ====== -->
    <div style="margin-top:10px; text-align:center;">
        <div class="intro-cta-group" style="display:none;">
            <button id="md-start-btn" class="intro-cta-primary">ë¶„ì„í•˜ê¸°</button>
        </div>

        <div id="md-viz-panel" class="md-viz-panel collapsed">
            <div class="md-viz-header" id="md-viz-header">
                <button type="button"
                        class="md-viz-pin"
                        id="md-viz-pin"
                        aria-label="ì‹œê°í™” ì—´ê¸°/ë‹«ê¸°">
                    ğŸ“Œ
                </button>

                <div class="md-viz-center">
                    <div class="md-viz-title">VISUALIZATION</div>
                    <div class="md-viz-sub">
                        Waveform / Spectrogram / FFT magnitude ì‹œê°í™” ê²°ê³¼í™•ì¸
                    </div>
                </div>

                <div class="md-viz-right md-viz-sub">
                    í´ë¦­í•´ì„œ ì—´ê³  ë‹«ê¸°
                </div>
            </div>

            <div class="md-viz-body">
                <div class="md-viz-row">
                    <div class="md-viz-block-full">
                        <div class="md-viz-block-title">Waveform (Time domain)</div>
                        <div class="md-viz-canvas-box">
                            <img id="md-img-waveform" class="md-viz-img" alt="Waveform">
                        </div>
                    </div>
                </div>

                <div class="md-viz-row">
                    <div class="md-viz-block-full">
                        <div class="md-viz-block-title">Spectrogram (Mel)</div>
                        <div class="md-viz-canvas-box">
                            <img id="md-img-mel" class="md-viz-img" alt="Mel spectrogram">
                        </div>
                    </div>
                </div>

                <div class="md-viz-row">
                    <div class="md-viz-block-full">
                        <div class="md-viz-block-title">FFT magnitude</div>
                        <div class="md-viz-canvas-box">
                            <img id="md-img-fft" class="md-viz-img" alt="FFT magnitude">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì§„ë‹¨ ê²°ê³¼ ë°•ìŠ¤ -->
    <div id="md-result-box" class="md-result-box" style="display:none;">
        <div class="md-result-left">
            <h3 class="md-result-title">ì§„ë‹¨ ê²°ê³¼</h3>
            <div class="md-result-text-wrap">
                <p id="md-result-text" class="md-result-text"></p>
            </div>
        </div>

        <div class="md-result-f1-wrap">
            <div class="md-result-f1-title">F1 score (í´ë˜ìŠ¤ë³„)</div>
            <div class="md-result-f1-box">
                <img id="md-img-f1" class="md-result-f1-img" alt="F1 score">
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const overlay = document.getElementById("secret-overlay");
  const input   = document.getElementById("secret-input");
  const submit  = document.getElementById("secret-submit");
  const errorEl = document.getElementById("secret-error");

  if (!overlay || !input || !submit) return;

  // ğŸ”‘ ì›í•˜ëŠ” ë¹„ë°€ í‚¤ ê°’
  const SECRET_KEY = "1234";

  // ğŸ”“ ì‹œí¬ë¦¿ í†µê³¼ í›„ ì‹¤í–‰í•  ì• ë‹ˆë©”ì´ì…˜ë“¤
  let introStarted = false;
  function startIntroAnimations() {
    if (introStarted) return;
    introStarted = true;

    // ë¡œê³  ì• ë‹ˆë©”ì´ì…˜ í’€ê¸°
    document.body.classList.add("secret-unlocked");

    // ìˆ«ì ì˜¬ë¼ê°€ëŠ” ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    if (typeof animateStats === "function") {
      animateStats();
    }
  }

  function tryUnlock() {
    const value = input.value.trim();

    if (value === SECRET_KEY) {
      // ì„±ê³µ: ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê³  ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
      overlay.style.display = "none";
      startIntroAnimations();
    } else {
      // ì‹¤íŒ¨: ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
      errorEl.style.display = "block";
    }
  }

  submit.addEventListener("click", tryUnlock);

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      tryUnlock();
    }
  });

  input.focus();
});

document.addEventListener('DOMContentLoaded', () => {
    // ===== ì‹œê°í™” íŒ¨ë„ í† ê¸€ =====
    const mdVizPanel  = document.getElementById('md-viz-panel');
    const mdVizHeader = document.getElementById('md-viz-header');
    if (mdVizHeader && mdVizPanel) {
        mdVizHeader.addEventListener('click', () => {
            mdVizPanel.classList.toggle('collapsed');
        });
    }

    // ===== ì´ë¯¸ì§€ src ì—…ë°ì´íŠ¸ (md.html ì½”ë“œ ì¬ì‚¬ìš©) =====
    function updateMdImages(images) {
        if (!images) return;
        const ts = Date.now();

        if (images.waveform) {
            const el = document.getElementById('md-img-waveform');
            if (el) el.src = images.waveform + '?t=' + ts;
        }
        if (images.mel) {
            const el = document.getElementById('md-img-mel');
            if (el) el.src = images.mel + '?t=' + ts;
        }
        if (images.fft) {
            const el = document.getElementById('md-img-fft');
            if (el) el.src = images.fft + '?t=' + ts;
        }
        if (images.f1) {
            const el = document.getElementById('md-img-f1');
            if (el) el.src = images.f1 + '?t=' + ts;
        }

        if (mdVizPanel) {
            mdVizPanel.classList.remove('collapsed');
        }
    }

    // ===== em í˜ì´ì§€ìš©: í° ì¹´ë“œ ë…¹ìŒ/ì—…ë¡œë“œ =====
    const recBtn   = document.getElementById('em-rec-btn');
    const statusEl = document.getElementById('em-status');
    const logEl    = document.getElementById('em-log');

    let mediaRecorder = null;
    let audioChunks   = [];
    let isRecording   = false;
    let cooldownTimer = null;

    function log(msg) {
        if (!logEl) return;
        const now = new Date().toLocaleTimeString();
        logEl.textContent = `[${now}] ${msg}\n` + logEl.textContent;
    }

    function setUIRecording(running) {
        isRecording = running;

        if (running) {
            recBtn.classList.add('recording');
            statusEl.textContent = "ë…¹ìŒ ì¤‘ì…ë‹ˆë‹¤... ì¹´ë“œë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ë…¹ìŒì´ ì¤‘ë‹¨ë©ë‹ˆë‹¤.";
        } else {
            recBtn.classList.remove('recording');
        }
    }

    async function startRecording() {
        if (isRecording || recBtn.disabled) return;

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ë§ˆì´í¬ ë…¹ìŒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });
            audioChunks = [];

            mediaRecorder.ondataavailable = (e) => {
                if (e.data && e.data.size > 0) {
                    audioChunks.push(e.data);
                }
            };

            mediaRecorder.onstop = handleStop;
            mediaRecorder.start();
            setUIRecording(true);
            log("ë…¹ìŒ ì‹œì‘");
        } catch (err) {
            console.error(err);
            alert("ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.");
        }
    }

    function stopRecording() {
        if (!isRecording || !mediaRecorder) return;
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
    }

    async function handleStop() {
        setUIRecording(false);
        log("ë…¹ìŒ ì¢…ë£Œ, ì„œë²„ë¡œ ì „ì†¡ ì¤‘...");

        const blob = new Blob(audioChunks, { type: "audio/webm" });

        const fd = new FormData();
        fd.append("state", "idle");            // í•„ìš”í•˜ë©´ braking/startup ìœ¼ë¡œ ë³€ê²½
        fd.append("audio", blob, "recording.webm");

        try {
            const res = await fetch("/md/predict", {
                method: "POST",
                body: fd
            });

            if (!res.ok) {
                throw new Error("Upload failed: " + res.status);
            }

            const data = await res.json();
            log("ì—…ë¡œë“œ ë° ë¶„ì„ ì™„ë£Œ");

            if (data.ok) {
                const r = data.result;

                if (r.images) {
                    updateMdImages(r.images);
                }

                let msg = `ìƒíƒœ: ${r.state}\nê²°ê³¼: ${r.label}`;
                if (typeof r.score === 'number') {
                    msg += `\nì ìˆ˜(score): ${r.score.toFixed(3)}`;
                }

                const box    = document.getElementById('md-result-box');
                const textEl = document.getElementById('md-result-text');
                if (box && textEl) {
                    textEl.textContent = msg;
                    box.style.display = 'grid';
                }

                statusEl.textContent = "ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. 30ì´ˆ í›„ì— ë‹¤ì‹œ ë…¹ìŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
            } else {
                statusEl.textContent = "ì¶”ë¡  ì‹¤íŒ¨: " + (data.error || 'unknown error');
            }

            recBtn.disabled = true;
            if (cooldownTimer) clearTimeout(cooldownTimer);
            cooldownTimer = setTimeout(() => {
                recBtn.disabled = false;
                statusEl.textContent = "ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ë…¹ìŒì„ ì‹œì‘í•©ë‹ˆë‹¤.";
            }, 30000);

        } catch (err) {
            console.error(err);
            log("ì—…ë¡œë“œ/ë¶„ì„ ì‹¤íŒ¨: " + err.message);
            alert("ì„œë²„ë¡œ íŒŒì¼ì„ ì „ì†¡í•˜ëŠ” ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            statusEl.textContent = "ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
        }
    }

    if (recBtn) {
        recBtn.addEventListener("click", () => {
            if (recBtn.disabled) return;
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        });
    }
});
</script>

{% endblock %}
